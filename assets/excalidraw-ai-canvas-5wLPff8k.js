import{s as e}from"./rolldown-runtime-B6ubh40S.js";import{N as t,P as n}from"./chakra-ui-DL3iEWi3.js";import"./react-syntax-highlighter-By7-4Brg.js";import{t as r}from"./excalidraw-DdtNXzWV.js";import"./react-utils-_zXiH43Z.js";import"./zenmark-editor-CcNuXx0R.js";import"./vendor-B06hKXvc.js";import"./common-utils-BE1DbrSU.js";import"./react-markdown-Dc1ste6M.js";import"./remark-gfm-CWYf_crh.js";import{At as i,Ct as a,Mt as o,Nt as s,Ot as c,W as l,_t as u,bt as d,jt as f,kt as p,l as m,r as h,wt as g,xt as _}from"./app-DK8K0KNv.js";import{i as v,n as y,r as b}from"./excalidraw-runtime-CNsNqpWR.js";var x=c(`CircleDot`,[[`circle`,{cx:`12`,cy:`12`,r:`10`,key:`1mglay`}],[`circle`,{cx:`12`,cy:`12`,r:`1`,key:`41hilf`}]]),S=c(`Save`,[[`path`,{d:`M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z`,key:`1c8476`}],[`path`,{d:`M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7`,key:`1ydtos`}],[`path`,{d:`M7 3v4a1 1 0 0 0 1 1h7`,key:`t51u73`}]]),C=e(n(),1);function w({sceneRef:e,excalidrawRef:t,onChange:n}){let{t:r}=u(),{toast:i}=d(),{openPane:a}=h(),[o,s]=(0,C.useState)([]),c=(0,C.useCallback)(async a=>{let o={id:Date.now().toString(),role:`user`,content:a,timestamp:Date.now()};s(e=>[...e,o]);let c=(Date.now()+1).toString(),l={id:c,role:`assistant`,content:``,timestamp:Date.now()+1};s(e=>[...e,l]);try{let o=await v.generateDiagram(a);if(t.current){let r=[...e.current.elements??[],...o];t.current.updateScene({elements:r});let i={elements:r,files:e.current.files};e.current=i,n(i)}s(e=>e.map(e=>e.id===c?{...e,content:r(`excalidraw.diagramGenerated`)}:e)),i({title:r(`excalidraw.generateSuccess`),description:r(`excalidraw.diagramAdded`)})}catch(e){console.error(`Error generating diagram:`,e),s(t=>t.map(t=>t.id===c?{...t,content:e instanceof Error?e.message:r(`excalidraw.generateError`)}:t)),i({title:r(`excalidraw.generateFailed`),description:e instanceof Error?e.message:r(`excalidraw.generateError`),variant:`destructive`})}},[n,i,t,e,r]);return{chatHistory:o,handleAIGenerate:c,openExcalidrawAssistant:(0,C.useCallback)(()=>{a(`excalidraw-agent`,{chatHistory:o,onGenerate:c})},[o,c,a])}}function T({sceneRef:e,excalidrawRef:t,onChange:n}){let r=m(n);(0,C.useEffect)(()=>{let n={getScene(){return{elements:e.current.elements??[],appState:null,files:e.current.files}},updateScene(n){if(!t.current)return;let i=e.current,a={elements:n.elements??i.elements??[],files:n.files??i.files};t.current.updateScene({elements:a.elements??[]}),e.current=a,r(a)}};return y(n),()=>b(n)},[r,e,t])}var E=e(t(),1),D=!1;function O(e){return{elements:e?.elements??[],files:e?.files,appState:e?.appState}}function k(e){return JSON.stringify({elements:e.elements??[],files:e.files??void 0})}function A({initialValue:e,onChange:t,saveStatus:n,onSaveClick:c,showSaveStatus:d}){let{t:h}=u(),v=(0,C.useMemo)(()=>O(e),[e]),y=(0,C.useRef)(null),b=(0,C.useRef)(v),k=m(t),{openExcalidrawAssistant:A}=w({sceneRef:b,excalidrawRef:y,onChange:k});T({sceneRef:b,excalidrawRef:y,onChange:k});let j=(0,C.useCallback)((e,t,n)=>{let r={elements:e,files:n,appState:t};b.current=r,k(r)},[k]);return(0,E.jsx)(`div`,{className:`h-full w-full flex flex-col bg-background overflow-hidden`,children:(0,E.jsx)(`div`,{className:`flex-1 relative flex min-h-0 overflow-hidden`,children:(0,E.jsxs)(`div`,{className:`flex-1 relative min-w-0 overflow-hidden`,children:[(0,E.jsxs)(`div`,{className:`absolute inset-0`,children:[d&&(0,E.jsx)(f,{children:(0,E.jsxs)(`div`,{className:`absolute right-3 top-1/2 -translate-y-1/2 z-20 flex flex-col items-center gap-2`,children:[(0,E.jsxs)(p,{children:[(0,E.jsx)(o,{asChild:!0,children:(0,E.jsx)(`div`,{className:`flex items-center justify-center w-8 h-8 rounded-full bg-background/80 border border-border/60 text-muted-foreground`,children:(()=>n===l.SAVING?(0,E.jsx)(_,{className:`h-4 w-4 animate-spin`}):n===l.DIRTY?(0,E.jsx)(x,{className:`h-4 w-4`}):n===l.ERROR?(0,E.jsx)(g,{className:`h-4 w-4 text-destructive`}):(0,E.jsx)(a,{className:`h-4 w-4 text-green-600`}))()})}),(0,E.jsx)(i,{children:(()=>n===l.SAVING?h(`excalidraw.saving`):n===l.DIRTY?h(`excalidraw.edited`):n===l.ERROR?h(`excalidraw.saveError`):h(`excalidraw.saved`))()})]}),c&&(0,E.jsxs)(p,{children:[(0,E.jsx)(o,{asChild:!0,children:(0,E.jsx)(s,{variant:`ghost`,size:`icon`,className:`h-8 w-8 rounded-full bg-background/80 border border-border/60 hover:bg-background`,onClick:c,children:(0,E.jsx)(S,{className:`h-4 w-4`})})}),(0,E.jsx)(i,{children:h(`excalidraw.saveNow`)})]})]})}),(0,E.jsx)(r,{initialData:{...v,scrollToContent:!0},excalidrawAPI:e=>{y.current=e},onChange:j,aiEnabled:!1})]}),D]})})})}export{A as ExcalidrawAICanvas,k as buildSceneSnapshot,O as normalizeSceneValue};