import{s as e}from"./rolldown-runtime-B6ubh40S.js";import{N as t,P as n}from"./chakra-ui-DL3iEWi3.js";import"./react-syntax-highlighter-CDqN2UN8.js";import{t as r}from"./excalidraw-yEEnJjZ9.js";import"./react-utils-wr8-iL4Y.js";import"./zenmark-editor-B3YBIbEI.js";import"./vendor-B06hKXvc.js";import"./common-utils-BE1DbrSU.js";import"./react-markdown-Dc1ste6M.js";import"./remark-gfm-CWYf_crh.js";import{At as i,Et as a,Ft as o,G as s,Mt as c,Nt as l,Pt as u,St as d,Tt as f,jt as p,r as m,u as h,vt as g,wt as _,xt as v}from"./app-CMv64s6i.js";import{i as y,n as b,r as x}from"./excalidraw-runtime-CdRhXUAU.js";var S=i(`Save`,[[`path`,{d:`M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z`,key:`1c8476`}],[`path`,{d:`M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7`,key:`1ydtos`}],[`path`,{d:`M7 3v4a1 1 0 0 0 1 1h7`,key:`t51u73`}]]),C=e(n(),1);function w({sceneRef:e,excalidrawRef:t,onChange:n}){let{t:r}=g(),{toast:i}=v(),{openPane:a}=m(),[o,s]=(0,C.useState)([]),c=(0,C.useCallback)(async a=>{let o={id:Date.now().toString(),role:`user`,content:a,timestamp:Date.now()};s(e=>[...e,o]);let c=(Date.now()+1).toString(),l={id:c,role:`assistant`,content:``,timestamp:Date.now()+1};s(e=>[...e,l]);try{let o=await y.generateDiagram(a);if(t.current){let r=[...e.current.elements??[],...o];t.current.updateScene({elements:r});let i={elements:r,files:e.current.files};e.current=i,n(i)}s(e=>e.map(e=>e.id===c?{...e,content:r(`excalidraw.diagramGenerated`)}:e)),i({title:r(`excalidraw.generateSuccess`),description:r(`excalidraw.diagramAdded`)})}catch(e){console.error(`Error generating diagram:`,e),s(t=>t.map(t=>t.id===c?{...t,content:e instanceof Error?e.message:r(`excalidraw.generateError`)}:t)),i({title:r(`excalidraw.generateFailed`),description:e instanceof Error?e.message:r(`excalidraw.generateError`),variant:`destructive`})}},[n,i,t,e,r]);return{chatHistory:o,handleAIGenerate:c,openExcalidrawAssistant:(0,C.useCallback)(()=>{a(`excalidraw-agent`,{chatHistory:o,onGenerate:c})},[o,c,a])}}function T({sceneRef:e,excalidrawRef:t,onChange:n}){let r=h(n);(0,C.useEffect)(()=>{let n={getScene(){return{elements:e.current.elements??[],appState:null,files:e.current.files}},updateScene(n){if(!t.current)return;let i=e.current,a={elements:n.elements??i.elements??[],files:n.files??i.files};t.current.updateScene({elements:a.elements??[]}),e.current=a,r(a)}};return b(n),()=>x(n)},[r,e,t])}var E=e(t(),1),D=!1;function O(e){return{elements:e?.elements??[],files:e?.files,appState:e?.appState}}function k(e){return JSON.stringify({elements:e.elements??[],files:e.files??void 0})}function A({initialValue:e,onChange:t,saveStatus:n,onSaveClick:i,showSaveStatus:m}){let{t:v}=g(),y=(0,C.useMemo)(()=>O(e),[e]),b=(0,C.useRef)(null),x=(0,C.useRef)(y),k=h(t),{openExcalidrawAssistant:A}=w({sceneRef:x,excalidrawRef:b,onChange:k});T({sceneRef:x,excalidrawRef:b,onChange:k});let j=(0,C.useCallback)((e,t,n)=>{let r={elements:e,files:n,appState:t};x.current=r,k(r)},[k]);return(0,E.jsx)(`div`,{className:`h-full w-full flex flex-col bg-background overflow-hidden`,children:(0,E.jsx)(`div`,{className:`flex-1 relative flex min-h-0 overflow-hidden`,children:(0,E.jsxs)(`div`,{className:`flex-1 relative min-w-0 overflow-hidden`,children:[(0,E.jsxs)(`div`,{className:`absolute inset-0`,children:[m&&(0,E.jsx)(l,{children:(0,E.jsxs)(`div`,{className:`absolute right-3 top-1/2 -translate-y-1/2 z-20 flex flex-col items-center gap-2`,children:[(0,E.jsxs)(p,{children:[(0,E.jsx)(u,{asChild:!0,children:(0,E.jsx)(`div`,{className:`flex items-center justify-center w-8 h-8 rounded-full bg-background/80 border border-border/60 text-muted-foreground`,children:(()=>n===s.SAVING?(0,E.jsx)(d,{className:`h-4 w-4 animate-spin`}):n===s.DIRTY?(0,E.jsx)(_,{className:`h-4 w-4`}):n===s.ERROR?(0,E.jsx)(a,{className:`h-4 w-4 text-destructive`}):(0,E.jsx)(f,{className:`h-4 w-4 text-green-600`}))()})}),(0,E.jsx)(c,{children:(()=>n===s.SAVING?v(`excalidraw.saving`):n===s.DIRTY?v(`excalidraw.edited`):n===s.ERROR?v(`excalidraw.saveError`):v(`excalidraw.saved`))()})]}),i&&(0,E.jsxs)(p,{children:[(0,E.jsx)(u,{asChild:!0,children:(0,E.jsx)(o,{variant:`ghost`,size:`icon`,className:`h-8 w-8 rounded-full bg-background/80 border border-border/60 hover:bg-background`,onClick:i,children:(0,E.jsx)(S,{className:`h-4 w-4`})})}),(0,E.jsx)(c,{children:v(`excalidraw.saveNow`)})]})]})}),(0,E.jsx)(r,{initialData:{...y,scrollToContent:!0},excalidrawAPI:e=>{b.current=e},onChange:j,aiEnabled:!1})]}),D]})})})}export{A as ExcalidrawAICanvas,k as buildSceneSnapshot,O as normalizeSceneValue};