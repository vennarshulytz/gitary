import"./chakra-ui-DL3iEWi3.js";import{xO as e}from"./excalidraw-BZQshQpt.js";import{t}from"./graphlib-BK5Zams0.js";import{t as n}from"./dagre-M6kol3xv.js";import{B as r,E as i,J as a,Y as o,c as s,u as c,ut as l,v as u}from"./mermaid-b5860b54-BPl11UBk.js";import{rt as d}from"./app-DZKVNN2E.js";import"./path-CZHMXrTW.js";import"./array-DZBJPEBo.js";import{t as f}from"./line-B6GAObyS.js";import{c as p,o as m,s as h}from"./styles-6aaf32cf-D-dxPyvd.js";l(),e(),a();var g={},_=(e,t)=>{g[e]=t},v=e=>g[e],y=()=>Object.keys(g),b={get:v,set:_,keys:y,size:()=>y().length},x=e=>e.append(`circle`).attr(`class`,`start-state`).attr(`r`,u().state.sizeUnit).attr(`cx`,u().state.padding+u().state.sizeUnit).attr(`cy`,u().state.padding+u().state.sizeUnit),S=e=>e.append(`line`).style(`stroke`,`grey`).style(`stroke-dasharray`,`3`).attr(`x1`,u().state.textHeight).attr(`class`,`divider`).attr(`x2`,u().state.textHeight*2).attr(`y1`,0).attr(`y2`,0),C=(e,t)=>{let n=e.append(`text`).attr(`x`,2*u().state.padding).attr(`y`,u().state.textHeight+2*u().state.padding).attr(`font-size`,u().state.fontSize).attr(`class`,`state-title`).text(t.id),r=n.node().getBBox();return e.insert(`rect`,`:first-child`).attr(`x`,u().state.padding).attr(`y`,u().state.padding).attr(`width`,r.width+2*u().state.padding).attr(`height`,r.height+2*u().state.padding).attr(`rx`,u().state.radius),n},w=(e,t)=>{let n=function(e,t,n){let r=e.append(`tspan`).attr(`x`,2*u().state.padding).text(t);n||r.attr(`dy`,u().state.textHeight)},r=e.append(`text`).attr(`x`,2*u().state.padding).attr(`y`,u().state.textHeight+1.3*u().state.padding).attr(`font-size`,u().state.fontSize).attr(`class`,`state-title`).text(t.descriptions[0]).node().getBBox(),i=r.height,a=e.append(`text`).attr(`x`,u().state.padding).attr(`y`,i+u().state.padding*.4+u().state.dividerMargin+u().state.textHeight).attr(`class`,`state-description`),o=!0,s=!0;t.descriptions.forEach(function(e){o||(n(a,e,s),s=!1),o=!1});let c=e.append(`line`).attr(`x1`,u().state.padding).attr(`y1`,u().state.padding+i+u().state.dividerMargin/2).attr(`y2`,u().state.padding+i+u().state.dividerMargin/2).attr(`class`,`descr-divider`),l=a.node().getBBox(),d=Math.max(l.width,r.width);return c.attr(`x2`,d+3*u().state.padding),e.insert(`rect`,`:first-child`).attr(`x`,u().state.padding).attr(`y`,u().state.padding).attr(`width`,d+2*u().state.padding).attr(`height`,l.height+i+2*u().state.padding).attr(`rx`,u().state.radius),e},T=(e,t,n)=>{let r=u().state.padding,i=2*u().state.padding,a=e.node().getBBox(),o=a.width,s=a.x,c=e.append(`text`).attr(`x`,0).attr(`y`,u().state.titleShift).attr(`font-size`,u().state.fontSize).attr(`class`,`state-title`).text(t.id),l=c.node().getBBox().width+i,d=Math.max(l,o);d===o&&(d+=i);let f,p=e.node().getBBox();t.doc,f=s-r,l>o&&(f=(o-d)/2+r),Math.abs(s-p.x)<r&&l>o&&(f=s-(l-o)/2);let m=1-u().state.textHeight;return e.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,m).attr(`class`,n?`alt-composit`:`composit`).attr(`width`,d).attr(`height`,p.height+u().state.textHeight+u().state.titleShift+1).attr(`rx`,`0`),c.attr(`x`,f+r),l<=o&&c.attr(`x`,s+(d-i)/2-l/2+r),e.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,u().state.titleShift-u().state.textHeight-u().state.padding).attr(`width`,d).attr(`height`,u().state.textHeight*3).attr(`rx`,u().state.radius),e.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,u().state.titleShift-u().state.textHeight-u().state.padding).attr(`width`,d).attr(`height`,p.height+3+2*u().state.textHeight).attr(`rx`,u().state.radius),e},E=e=>(e.append(`circle`).attr(`class`,`end-state-outer`).attr(`r`,u().state.sizeUnit+u().state.miniPadding).attr(`cx`,u().state.padding+u().state.sizeUnit+u().state.miniPadding).attr(`cy`,u().state.padding+u().state.sizeUnit+u().state.miniPadding),e.append(`circle`).attr(`class`,`end-state-inner`).attr(`r`,u().state.sizeUnit).attr(`cx`,u().state.padding+u().state.sizeUnit+2).attr(`cy`,u().state.padding+u().state.sizeUnit+2)),D=(e,t)=>{let n=u().state.forkWidth,r=u().state.forkHeight;if(t.parentId){let e=n;n=r,r=e}return e.append(`rect`).style(`stroke`,`black`).style(`fill`,`black`).attr(`width`,n).attr(`height`,r).attr(`x`,u().state.padding).attr(`y`,u().state.padding)},O=(e,t,n,r)=>{let i=0,a=r.append(`text`);a.style(`text-anchor`,`start`),a.attr(`class`,`noteText`);let o=e.replace(/\r\n/g,`<br/>`);o=o.replace(/\n/g,`<br/>`);let c=o.split(s.lineBreakRegex),l=1.25*u().state.noteMargin;for(let e of c){let r=e.trim();if(r.length>0){let e=a.append(`tspan`);if(e.text(r),l===0){let t=e.node().getBBox();l+=t.height}i+=l,e.attr(`x`,t+u().state.noteMargin),e.attr(`y`,n+i+1.25*u().state.noteMargin)}}return{textWidth:a.node().getBBox().width,textHeight:i}},k=(e,t)=>{t.attr(`class`,`state-note`);let n=t.append(`rect`).attr(`x`,0).attr(`y`,u().state.padding),{textWidth:r,textHeight:i}=O(e,0,0,t.append(`g`));return n.attr(`height`,i+2*u().state.noteMargin),n.attr(`width`,r+u().state.noteMargin*2),n},A=function(e,t){let n=t.id,r={id:n,label:t.id,width:0,height:0},i=e.append(`g`).attr(`id`,n).attr(`class`,`stateGroup`);t.type===`start`&&x(i),t.type===`end`&&E(i),(t.type===`fork`||t.type===`join`)&&D(i,t),t.type===`note`&&k(t.note.text,i),t.type===`divider`&&S(i),t.type===`default`&&t.descriptions.length===0&&C(i,t),t.type===`default`&&t.descriptions.length>0&&w(i,t);let a=i.node().getBBox();return r.width=a.width+2*u().state.padding,r.height=a.height+2*u().state.padding,b.set(n,r),r},j=0,M=function(e,t,n){let a=function(e){switch(e){case m.relationType.AGGREGATION:return`aggregation`;case m.relationType.EXTENSION:return`extension`;case m.relationType.COMPOSITION:return`composition`;case m.relationType.DEPENDENCY:return`dependency`}};t.points=t.points.filter(e=>!Number.isNaN(e.y));let c=t.points,l=f().x(function(e){return e.x}).y(function(e){return e.y}).curve(o),d=e.append(`path`).attr(`d`,l(c)).attr(`id`,`edge`+j).attr(`class`,`transition`),p=``;if(u().state.arrowMarkerAbsolute&&(p=window.location.protocol+`//`+window.location.host+window.location.pathname+window.location.search,p=p.replace(/\(/g,`\\(`),p=p.replace(/\)/g,`\\)`)),d.attr(`marker-end`,`url(`+p+`#`+a(m.relationType.DEPENDENCY)+`End)`),n.title!==void 0){let a=e.append(`g`).attr(`class`,`stateLabel`),{x:o,y:c}=r.calcLabelPosition(t.points),l=s.getRows(n.title),d=0,f=[],p=0,m=0;for(let e=0;e<=l.length;e++){let t=a.append(`text`).attr(`text-anchor`,`middle`).text(l[e]).attr(`x`,o).attr(`y`,c+d),n=t.node().getBBox();p=Math.max(p,n.width),m=Math.min(m,n.x),i.info(n.x,o,c+d),d===0&&(d=t.node().getBBox().height,i.info(`Title height`,d,c)),f.push(t)}let h=d*l.length;if(l.length>1){let e=(l.length-1)*d*.5;f.forEach((t,n)=>t.attr(`y`,c+n*d-e)),h=d*l.length}let g=a.node().getBBox();a.insert(`rect`,`:first-child`).attr(`class`,`box`).attr(`x`,o-p/2-u().state.padding/2).attr(`y`,c-h/2-u().state.padding/2-3.5).attr(`width`,p+u().state.padding).attr(`height`,h+u().state.padding),i.info(g)}j++},N,P={},F=function(){},I=function(e){e.append(`defs`).append(`marker`).attr(`id`,`dependencyEnd`).attr(`refX`,19).attr(`refY`,7).attr(`markerWidth`,20).attr(`markerHeight`,28).attr(`orient`,`auto`).append(`path`).attr(`d`,`M 19,7 L9,13 L14,7 L9,1 Z`)},L=function(e,t,n,r){N=u().state;let a=u().securityLevel,o;a===`sandbox`&&(o=d(`#i`+t));let s=d(a===`sandbox`?o.nodes()[0].contentDocument.body:`body`),l=a===`sandbox`?o.nodes()[0].contentDocument:document;i.debug(`Rendering diagram `+e);let f=s.select(`[id='${t}']`);I(f),z(r.db.getRootDoc(),f,void 0,!1,s,l,r);let p=N.padding,m=f.node().getBBox(),h=m.width+p*2,g=m.height+p*2;c(f,g,h*1.75,N.useMaxWidth),f.attr(`viewBox`,`${m.x-N.padding}  ${m.y-N.padding} `+h+` `+g)},R=e=>e?e.length*N.fontSizeFactor:1,z=(e,r,a,o,c,l,u)=>{let d=new t({compound:!0,multigraph:!0}),f,p=!0;for(f=0;f<e.length;f++)if(e[f].stmt===`relation`){p=!1;break}a?d.setGraph({rankdir:`LR`,multigraph:!0,compound:!0,ranker:`tight-tree`,ranksep:p?1:N.edgeLengthFactor,nodeSep:p?1:50,isMultiGraph:!0}):d.setGraph({rankdir:`TB`,multigraph:!0,compound:!0,ranksep:p?1:N.edgeLengthFactor,nodeSep:p?1:50,ranker:`tight-tree`,isMultiGraph:!0}),d.setDefaultEdgeLabel(function(){return{}}),u.db.extract(e);let m=u.db.getStates(),h=u.db.getRelations(),g=Object.keys(m);for(let e of g){let t=m[e];a&&(t.parentId=a);let n;if(t.doc){let e=r.append(`g`).attr(`id`,t.id).attr(`class`,`stateGroup`);n=z(t.doc,e,t.id,!o,c,l,u);{e=T(e,t,o);let r=e.node().getBBox();n.width=r.width,n.height=r.height+N.padding/2,P[t.id]={y:N.compositTitleSize}}}else n=A(r,t);if(t.note){let e=A(r,{descriptions:[],id:t.id+`-note`,note:t.note,type:`note`});t.note.position===`left of`?(d.setNode(n.id+`-note`,e),d.setNode(n.id,n)):(d.setNode(n.id,n),d.setNode(n.id+`-note`,e)),d.setParent(n.id,n.id+`-group`),d.setParent(n.id+`-note`,n.id+`-group`)}else d.setNode(n.id,n)}i.debug(`Count=`,d.nodeCount(),d);let _=0;h.forEach(function(e){_++,i.debug(`Setting edge`,e),d.setEdge(e.id1,e.id2,{relation:e,width:R(e.title),height:N.labelHeight*s.getRows(e.title).length,labelpos:`c`},`id`+_)}),n(d),i.debug(`Graph after layout`,d.nodes());let v=r.node();d.nodes().forEach(function(e){e!==void 0&&d.node(e)!==void 0?(i.warn(`Node `+e+`: `+JSON.stringify(d.node(e))),c.select(`#`+v.id+` #`+e).attr(`transform`,`translate(`+(d.node(e).x-d.node(e).width/2)+`,`+(d.node(e).y+(P[e]?P[e].y:0)-d.node(e).height/2)+` )`),c.select(`#`+v.id+` #`+e).attr(`data-x-shift`,d.node(e).x-d.node(e).width/2),l.querySelectorAll(`#`+v.id+` #`+e+` .divider`).forEach(e=>{let t=e.parentElement,n=0,r=0;t&&(t.parentElement&&(n=t.parentElement.getBBox().width),r=parseInt(t.getAttribute(`data-x-shift`),10),Number.isNaN(r)&&(r=0)),e.setAttribute(`x1`,0-r+8),e.setAttribute(`x2`,n-r-8)})):i.debug(`No Node `+e+`: `+JSON.stringify(d.node(e)))});let y=v.getBBox();d.edges().forEach(function(e){e!==void 0&&d.edge(e)!==void 0&&(i.debug(`Edge `+e.v+` -> `+e.w+`: `+JSON.stringify(d.edge(e))),M(r,d.edge(e),d.edge(e).relation))}),y=v.getBBox();let b={id:a||`root`,label:a||`root`,width:0,height:0};return b.width=y.width+2*N.padding,b.height=y.height+2*N.padding,i.debug(`Doc rendered`,b,d),b},B={parser:h,db:m,renderer:{setConf:F,draw:L},styles:p,init:e=>{e.state||={},e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute,m.clear()}};export{B as diagram};