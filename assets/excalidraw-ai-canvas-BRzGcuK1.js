import{s as e}from"./rolldown-runtime-B6ubh40S.js";import{N as t,P as n}from"./chakra-ui-DL3iEWi3.js";import"./react-syntax-highlighter-Bd-UzC9z.js";import{t as r}from"./excalidraw-D5Q9WXro.js";import"./react-utils-B4ri0EFn.js";import"./zenmark-editor-BzPfrJNY.js";import"./vendor-B06hKXvc.js";import"./common-utils-BE1DbrSU.js";import"./react-markdown-CPDF2saO.js";import"./remark-gfm-Dq85BUSX.js";import{$ as i,G as a,H as o,Q as s,R as c,V as l,W as u,X as d,Y as f,Z as p,et as m,l as h,r as g,u as _}from"./app-w2Jd5jCf.js";import{i as v,n as y,r as b}from"./excalidraw-runtime-fj1jY81z.js";var x=f(`CircleDot`,[[`circle`,{cx:`12`,cy:`12`,r:`10`,key:`1mglay`}],[`circle`,{cx:`12`,cy:`12`,r:`1`,key:`41hilf`}]]),S=f(`Save`,[[`path`,{d:`M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z`,key:`1c8476`}],[`path`,{d:`M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7`,key:`1ydtos`}],[`path`,{d:`M7 3v4a1 1 0 0 0 1 1h7`,key:`t51u73`}]]),C=e(n(),1);function w({sceneRef:e,excalidrawRef:t,onChange:n}){let{t:r}=c(),{toast:i}=l(),{openPane:a}=g(),[o,s]=(0,C.useState)([]),u=(0,C.useCallback)(async a=>{let o={id:Date.now().toString(),role:`user`,content:a,timestamp:Date.now()};s(e=>[...e,o]);let c=(Date.now()+1).toString(),l={id:c,role:`assistant`,content:``,timestamp:Date.now()+1};s(e=>[...e,l]);try{let o=await v.generateDiagram(a);if(t.current){let r=[...e.current.elements??[],...o];t.current.updateScene({elements:r});let i={elements:r,files:e.current.files};e.current=i,n(i)}s(e=>e.map(e=>e.id===c?{...e,content:r(`excalidraw.diagramGenerated`)}:e)),i({title:r(`excalidraw.generateSuccess`),description:r(`excalidraw.diagramAdded`)})}catch(e){console.error(`Error generating diagram:`,e),s(t=>t.map(t=>t.id===c?{...t,content:e instanceof Error?e.message:r(`excalidraw.generateError`)}:t)),i({title:r(`excalidraw.generateFailed`),description:e instanceof Error?e.message:r(`excalidraw.generateError`),variant:`destructive`})}},[n,i,t,e,r]);return{chatHistory:o,handleAIGenerate:u,openExcalidrawAssistant:(0,C.useCallback)(()=>{a(`excalidraw-agent`,{chatHistory:o,onGenerate:u})},[o,u,a])}}function T({sceneRef:e,excalidrawRef:t,onChange:n}){let r=h(n);(0,C.useEffect)(()=>{let n={getScene(){return{elements:e.current.elements??[],appState:null,files:e.current.files}},updateScene(n){if(!t.current)return;let i=e.current,a={elements:n.elements??i.elements??[],files:n.files??i.files};t.current.updateScene({elements:a.elements??[]}),e.current=a,r(a)}};return y(n),()=>b(n)},[r,e,t])}var E=e(t(),1),D=!1;function O(e){return{elements:e?.elements??[],files:e?.files,appState:e?.appState}}function k(e){return JSON.stringify({elements:e.elements??[],files:e.files??void 0})}function A({initialValue:e,onChange:t,saveStatus:n,onSaveClick:l,showSaveStatus:f}){let{t:g}=c(),v=(0,C.useMemo)(()=>O(e),[e]),y=(0,C.useRef)(null),b=(0,C.useRef)(v),k=h(t),{openExcalidrawAssistant:A}=w({sceneRef:b,excalidrawRef:y,onChange:k});T({sceneRef:b,excalidrawRef:y,onChange:k});let j=(0,C.useCallback)((e,t,n)=>{let r={elements:e,files:n,appState:t};b.current=r,k(r)},[k]);return(0,E.jsx)(`div`,{className:`h-full w-full flex flex-col bg-background overflow-hidden`,children:(0,E.jsx)(`div`,{className:`flex-1 relative flex min-h-0 overflow-hidden`,children:(0,E.jsxs)(`div`,{className:`flex-1 relative min-w-0 overflow-hidden`,children:[(0,E.jsxs)(`div`,{className:`absolute inset-0`,children:[f&&(0,E.jsx)(s,{children:(0,E.jsxs)(`div`,{className:`absolute right-3 top-1/2 -translate-y-1/2 z-20 flex flex-col items-center gap-2`,children:[(0,E.jsxs)(d,{children:[(0,E.jsx)(i,{asChild:!0,children:(0,E.jsx)(`div`,{className:`flex items-center justify-center w-8 h-8 rounded-full bg-background/80 border border-border/60 text-muted-foreground`,children:(()=>n===_.SAVING?(0,E.jsx)(o,{className:`h-4 w-4 animate-spin`}):n===_.DIRTY?(0,E.jsx)(x,{className:`h-4 w-4`}):n===_.ERROR?(0,E.jsx)(a,{className:`h-4 w-4 text-destructive`}):(0,E.jsx)(u,{className:`h-4 w-4 text-green-600`}))()})}),(0,E.jsx)(p,{children:(()=>n===_.SAVING?g(`excalidraw.saving`):n===_.DIRTY?g(`excalidraw.edited`):n===_.ERROR?g(`excalidraw.saveError`):g(`excalidraw.saved`))()})]}),l&&(0,E.jsxs)(d,{children:[(0,E.jsx)(i,{asChild:!0,children:(0,E.jsx)(m,{variant:`ghost`,size:`icon`,className:`h-8 w-8 rounded-full bg-background/80 border border-border/60 hover:bg-background`,onClick:l,children:(0,E.jsx)(S,{className:`h-4 w-4`})})}),(0,E.jsx)(p,{children:g(`excalidraw.saveNow`)})]})]})}),(0,E.jsx)(r,{initialData:{...v,scrollToContent:!0},excalidrawAPI:e=>{y.current=e},onChange:j,aiEnabled:!1})]}),D]})})})}export{A as ExcalidrawAICanvas,k as buildSceneSnapshot,O as normalizeSceneValue};