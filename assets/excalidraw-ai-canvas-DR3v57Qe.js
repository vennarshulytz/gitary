import{s as e}from"./rolldown-runtime-B6ubh40S.js";import{N as t,P as n}from"./chakra-ui-DL3iEWi3.js";import"./react-syntax-highlighter-DZJ3xuxL.js";import{t as r}from"./excalidraw-C6jnf2-D.js";import"./react-utils-SEY4J1h3.js";import"./zenmark-editor-Dy951ayJ.js";import"./vendor-Bdw1rj8N.js";import"./common-utils-DCzOnVm6.js";import"./react-markdown-Dc1ste6M.js";import"./remark-gfm-CWYf_crh.js";import{At as i,Ct as a,Dt as o,Lt as s,Mt as c,Ot as l,St as u,W as d,jt as f,kt as p,r as m,st as h,vt as g,xt as _,yt as v}from"./app-4U6778Bu.js";import{i as y,n as b,r as x}from"./excalidraw-runtime-DcWknLgS.js";var S=o(`Save`,[[`path`,{d:`M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z`,key:`1c8476`}],[`path`,{d:`M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7`,key:`1ydtos`}],[`path`,{d:`M7 3v4a1 1 0 0 0 1 1h7`,key:`t51u73`}]]),C=e(n(),1);function w({sceneRef:e,excalidrawRef:t,onChange:n}){let{t:r}=s(),{toast:i}=g(),{openPane:a}=m(),[o,c]=(0,C.useState)([]),l=(0,C.useCallback)(async a=>{let o={id:Date.now().toString(),role:`user`,content:a,timestamp:Date.now()};c(e=>[...e,o]);let s=(Date.now()+1).toString(),l={id:s,role:`assistant`,content:``,timestamp:Date.now()+1};c(e=>[...e,l]);try{let o=await y.generateDiagram(a);if(t.current){let r=[...e.current.elements??[],...o];t.current.updateScene({elements:r});let i={elements:r,files:e.current.files};e.current=i,n(i)}c(e=>e.map(e=>e.id===s?{...e,content:r(`excalidraw.diagramGenerated`)}:e)),i({title:r(`excalidraw.generateSuccess`),description:r(`excalidraw.diagramAdded`)})}catch(e){console.error(`Error generating diagram:`,e),c(t=>t.map(t=>t.id===s?{...t,content:e instanceof Error?e.message:r(`excalidraw.generateError`)}:t)),i({title:r(`excalidraw.generateFailed`),description:e instanceof Error?e.message:r(`excalidraw.generateError`),variant:`destructive`})}},[n,i,t,e,r]);return{chatHistory:o,handleAIGenerate:l,openExcalidrawAssistant:(0,C.useCallback)(()=>{a(`excalidraw-agent`,{chatHistory:o,onGenerate:l})},[o,l,a])}}function T({sceneRef:e,excalidrawRef:t,onChange:n}){let r=h(n);(0,C.useEffect)(()=>{let n={getScene(){return{elements:e.current.elements??[],appState:null,files:e.current.files}},updateScene(n){if(!t.current)return;let i=e.current,a={elements:n.elements??i.elements??[],files:n.files??i.files};t.current.updateScene({elements:a.elements??[]}),e.current=a,r(a)}};return b(n),()=>x(n)},[r,e,t])}var E=e(t(),1),D=!1;function O(e){return{elements:e?.elements??[],files:e?.files,appState:e?.appState}}function k(e){return JSON.stringify({elements:e.elements??[],files:e.files??void 0})}function A({initialValue:e,onChange:t,saveStatus:n,onSaveClick:o,showSaveStatus:m}){let{t:g}=s(),y=(0,C.useMemo)(()=>O(e),[e]),b=(0,C.useRef)(null),x=(0,C.useRef)(y),k=h(t),{openExcalidrawAssistant:A}=w({sceneRef:x,excalidrawRef:b,onChange:k});T({sceneRef:x,excalidrawRef:b,onChange:k});let j=(0,C.useCallback)((e,t,n)=>{let r={elements:e,files:n,appState:t};x.current=r,k(r)},[k]);return(0,E.jsx)(`div`,{className:`h-full w-full flex flex-col bg-background overflow-hidden`,children:(0,E.jsx)(`div`,{className:`flex-1 relative flex min-h-0 overflow-hidden`,children:(0,E.jsxs)(`div`,{className:`flex-1 relative min-w-0 overflow-hidden`,children:[(0,E.jsxs)(`div`,{className:`absolute inset-0`,children:[m&&(0,E.jsx)(i,{children:(0,E.jsxs)(`div`,{className:`absolute right-3 top-1/2 -translate-y-1/2 z-20 flex flex-col items-center gap-2`,children:[(0,E.jsxs)(l,{children:[(0,E.jsx)(f,{asChild:!0,children:(0,E.jsx)(`div`,{className:`flex items-center justify-center w-8 h-8 rounded-full bg-background/80 border border-border/60 text-muted-foreground`,children:(()=>n===d.SAVING?(0,E.jsx)(v,{className:`h-4 w-4 animate-spin`}):n===d.DIRTY?(0,E.jsx)(_,{className:`h-4 w-4`}):n===d.ERROR?(0,E.jsx)(a,{className:`h-4 w-4 text-destructive`}):(0,E.jsx)(u,{className:`h-4 w-4 text-green-600`}))()})}),(0,E.jsx)(p,{children:(()=>n===d.SAVING?g(`excalidraw.saving`):n===d.DIRTY?g(`excalidraw.edited`):n===d.ERROR?g(`excalidraw.saveError`):g(`excalidraw.saved`))()})]}),o&&(0,E.jsxs)(l,{children:[(0,E.jsx)(f,{asChild:!0,children:(0,E.jsx)(c,{variant:`ghost`,size:`icon`,className:`h-8 w-8 rounded-full bg-background/80 border border-border/60 hover:bg-background`,onClick:o,children:(0,E.jsx)(S,{className:`h-4 w-4`})})}),(0,E.jsx)(p,{children:g(`excalidraw.saveNow`)})]})]})}),(0,E.jsx)(r,{initialData:{...y,scrollToContent:!0},excalidrawAPI:e=>{b.current=e},onChange:j,aiEnabled:!1})]}),D]})})})}export{A as ExcalidrawAICanvas,k as buildSceneSnapshot,O as normalizeSceneValue};